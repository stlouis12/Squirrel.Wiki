@using Squirrel.Wiki.Core.Models
@using Squirrel.Wiki.Core.Database.Entities
@using Squirrel.Wiki.Core.Services.Configuration
@using Squirrel.Wiki.Web.Extensions
@inject IStringLocalizer<SharedResources> Localizer
@inject ITimezoneService TimezoneService

@{
    ViewData["Title"] = Localizer["FileBrowser"];
    var currentFolder = ViewBag.CurrentFolder as FolderDto;
    var folders = ViewBag.Folders as IEnumerable<FolderDto> ?? Enumerable.Empty<FolderDto>();
    var files = ViewBag.Files as IEnumerable<FileDto> ?? Enumerable.Empty<FileDto>();
    var breadcrumb = ViewBag.Breadcrumb as List<FolderDto> ?? new List<FolderDto>();
    var searchQuery = ViewBag.SearchQuery as string;
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>
                        <i class="bi bi-folder2-open"></i>
                        @if (currentFolder != null)
                        {
                            @currentFolder.Name
                        }
                        else
                        {
                            <text>@Localizer["FileBrowser"]</text>
                        }
                    </h2>
                    
                    @if (breadcrumb.Any())
                    {
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a asp-action="Browse">
                                        <i class="bi bi-house-door"></i> @Localizer["Home"]
                                    </a>
                                </li>
                                @foreach (var folder in breadcrumb)
                                {
                                    <li class="breadcrumb-item">
                                        <a asp-action="Browse" asp-route-folderId="@folder.Id">
                                            @folder.Name
                                        </a>
                                    </li>
                                }
                            </ol>
                        </nav>
                    }
                </div>
                
                <div>
                    <form asp-action="Browse" method="get" class="d-flex">
                        <input type="hidden" name="folderId" value="@currentFolder?.Id" />
                        <input type="search" 
                               name="search" 
                               class="form-control me-2" 
                               placeholder="@Localizer["SearchFiles"]..." 
                               value="@searchQuery"
                               style="width: 300px;" />
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> @Localizer["Search"]
                        </button>
                        @if (!string.IsNullOrWhiteSpace(searchQuery))
                        {
                            <a asp-action="Browse" asp-route-folderId="@currentFolder?.Id" class="btn btn-secondary ms-2">
                                <i class="bi bi-x-circle"></i> @Localizer["Clear"]
                            </a>
                        }
                    </form>
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    @Localizer["ShowingSearchResultsFor"]: <strong>@searchQuery</strong>
                    (@files.Count() @Localizer["FilesFound"])
                </div>
            }

            @if (currentFolder != null && !string.IsNullOrEmpty(currentFolder.Description))
            {
                <div class="alert alert-secondary">
                    <i class="bi bi-info-circle"></i>
                    @currentFolder.Description
                </div>
            }

            <!-- Folders Section -->
            @if (folders.Any() && string.IsNullOrWhiteSpace(searchQuery))
            {
                <div class="mb-4">
                    <h5 class="mb-3">
                        <i class="bi bi-folder"></i> @Localizer["Folders"]
                    </h5>
                    <div class="row g-3">
                        @foreach (var folder in folders)
                        {
                            <div class="col-md-3 col-sm-6">
                                <a asp-action="Browse" asp-route-folderId="@folder.Id" class="text-decoration-none">
                                    <div class="card h-100 folder-card">
                                        <div class="card-body text-center">
                                            <i class="bi bi-folder-fill text-warning" style="font-size: 3rem;"></i>
                                            <h6 class="card-title mt-2 mb-1">@folder.Name</h6>
                                            @if (!string.IsNullOrEmpty(folder.Description))
                                            {
                                                <p class="card-text small text-muted">@folder.Description</p>
                                            }
                                            <p class="card-text small text-muted">
                                                <i class="bi bi-file-earmark"></i> @folder.FileCount @Localizer["FileCount"]
                                            </p>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Files Section -->
            @if (files.Any())
            {
                <div>
                    <h5 class="mb-3">
                        <i class="bi bi-file-earmark"></i> @Localizer["Files"]
                        <span class="badge bg-secondary">@files.Count()</span>
                    </h5>
                    <div class="row g-3">
                        @foreach (var file in files)
                        {
                            var isImage = file.ContentType.StartsWith("image/", StringComparison.OrdinalIgnoreCase);
                            var isPdf = file.ContentType == "application/pdf";
                            var iconClass = GetFileIcon(file.ContentType);
                            
                            <div class="col-md-3 col-sm-6">
                                <div class="card h-100 file-card">
                                    <div class="card-body">
                                        <div class="text-center mb-2">
                                            @if (isImage)
                                            {
                                                <img src="@Url.Action("Download", "Files", new { id = file.Id })" 
                                                     class="img-fluid rounded" 
                                                     alt="@file.FileName"
                                                     style="max-height: 150px; object-fit: cover;" />
                                            }
                                            else
                                            {
                                                <i class="@iconClass" style="font-size: 3rem;"></i>
                                            }
                                        </div>
                                        
                                        <h6 class="card-title text-truncate" title="@file.FileName">
                                            @file.FileName
                                        </h6>
                                        
                                        @if (!string.IsNullOrEmpty(file.Description))
                                        {
                                            <p class="card-text small text-muted">@file.Description</p>
                                        }
                                        
                                        <div class="d-flex justify-content-between align-items-center small text-muted mb-2">
                                            <span>
                                                <i class="bi bi-hdd"></i> @FormatFileSize(file.FileSize)
                                            </span>
                                            <span title="@await file.UploadedOn.ToLocalTimeStringAsync(TimezoneService, "F")">
                                                <i class="bi bi-calendar"></i> @await file.UploadedOn.ToLocalTimeStringAsync(TimezoneService, "MMM dd, yyyy")
                                            </span>
                                        </div>
                                        
                        @if (file.Visibility == FileVisibility.Private)
                        {
                            <span class="badge bg-warning text-dark mb-2">
                                <i class="bi bi-lock"></i> @Localizer["Private"]
                            </span>
                        }
                        else if (file.Visibility == FileVisibility.Public)
                                        {
                                            <span class="badge bg-success mb-2">
                                                <i class="bi bi-globe"></i> @Localizer["Public"]
                                            </span>
                                        }
                                        
                                        <div class="d-grid gap-2">
                                            <a href="@Url.Action("Download", "Files", new { id = file.Id })" 
                                               class="btn btn-primary btn-sm">
                                                <i class="bi bi-download"></i> @Localizer["Download"]
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Empty State -->
            @if (!folders.Any() && !files.Any())
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                    <h4 class="mt-3 text-muted">
                        @if (!string.IsNullOrWhiteSpace(searchQuery))
                        {
                            <text>@Localizer["NoFilesFoundMatchingSearch"]</text>
                        }
                        else if (currentFolder != null)
                        {
                            <text>@Localizer["ThisFolderIsEmpty"]</text>
                        }
                        else
                        {
                            <text>@Localizer["NoFilesAvailable"]</text>
                        }
                    </h4>
                    @if (!string.IsNullOrWhiteSpace(searchQuery))
                    {
                        <p class="text-muted">@Localizer["TryDifferentSearchTerm"]</p>
                        <a asp-action="Browse" asp-route-folderId="@currentFolder?.Id" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> @Localizer["BackToBrowse"]
                        </a>
                    }
                </div>
            }
        </div>
    </div>
</div>

@functions {
    string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
    
    string GetFileIcon(string contentType)
    {
        return contentType.ToLower() switch
        {
            var ct when ct.StartsWith("image/") => "bi bi-file-image text-primary",
            var ct when ct.StartsWith("video/") => "bi bi-file-play text-danger",
            var ct when ct.StartsWith("audio/") => "bi bi-file-music text-info",
            "application/pdf" => "bi bi-file-pdf text-danger",
            "application/msword" or "application/vnd.openxmlformats-officedocument.wordprocessingml.document" => "bi bi-file-word text-primary",
            "application/vnd.ms-excel" or "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" => "bi bi-file-excel text-success",
            "application/vnd.ms-powerpoint" or "application/vnd.openxmlformats-officedocument.presentationml.presentation" => "bi bi-file-ppt text-warning",
            "application/zip" or "application/x-zip-compressed" or "application/x-rar-compressed" => "bi bi-file-zip text-secondary",
            var ct when ct.StartsWith("text/") => "bi bi-file-text text-secondary",
            _ => "bi bi-file-earmark text-secondary"
        };
    }
}

@section Styles {
    <style>
        .folder-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .folder-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .file-card {
            transition: box-shadow 0.2s;
        }
        
        .file-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .breadcrumb {
            background-color: transparent;
            padding: 0;
            margin-bottom: 0;
        }
    </style>
}
