@model Squirrel.Wiki.Web.Models.Admin.EditCategoryViewModel
@{
    ViewData["Title"] = Model.IsNew ? Localizer["CreateCategory"].Value : Localizer["EditCategory"].Value;
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>
                <i class="bi bi-@(Model.IsNew ? "plus-circle" : "pencil")"></i> 
                @(Model.IsNew ? Localizer["CreateCategory"] : Localizer["EditCategory"])
            </h1>
            @if (!string.IsNullOrEmpty(Model.CurrentPath))
            {
                <p class="text-muted">
                    <i class="bi bi-diagram-3"></i> @Localizer["CurrentPath"] <code>@Model.CurrentPath</code>
                </p>
            }
        </div>
        <div class="col-auto">
            <a asp-action="Index" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> @Localizer["BackToCategories"]
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> @Localizer["CategoryInformation"]
                    </h5>
                </div>
                <div class="card-body">
                    <form asp-action="Save" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Id" />
                        
                        <div class="mb-3">
                            <label asp-for="Name" class="form-label">
                                @Localizer["CategoryName"] <span class="text-danger">*</span>
                            </label>
                            <input asp-for="Name" class="form-control" placeholder="@Localizer["CategoryNamePlaceholder"]" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> @Localizer["UseLettersNumbersSpaces"]
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label">@Localizer["Description"]</label>
                            <textarea asp-for="Description" class="form-control" rows="3" 
                                      placeholder="@Localizer["BriefDescriptionOptional"]"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ParentId" class="form-label">@Localizer["ParentCategory"]</label>
                            <select asp-for="ParentId" class="form-select" id="parentCategorySelect">
                                @foreach (var parent in Model.AvailableParents)
                                {
                                    if (parent.Id == 0)
                                    {
                                        <option value="" 
                                                data-level="@parent.Level"
                                                data-path="@parent.FullPath">
                                            @parent.DisplayName
                                        </option>
                                    }
                                    else
                                    {
                                        <option value="@parent.Id" 
                                                disabled="@parent.IsDisabled"
                                                data-level="@parent.Level"
                                                data-path="@parent.FullPath">
                                            @parent.DisplayName
                                        </option>
                                    }
                                }
                            </select>
                            <span asp-validation-for="ParentId" class="text-danger"></span>
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> @Localizer["SelectParentToCreateSubcategory"]
                                <br />
                                <i class="bi bi-exclamation-triangle text-warning"></i> <small>Categories at maximum nesting depth are disabled and cannot have children.</small>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(Model.CurrentPath))
                        {
                            <div class="alert alert-info">
                                <h6><i class="bi bi-diagram-3"></i> @Localizer["CategoryPathPreview"]</h6>
                                <div class="mb-2">
                                    <strong>@Localizer["Current"]</strong> <code id="currentPath">@Model.CurrentPath</code>
                                </div>
                                <div>
                                    <strong>@Localizer["New"]</strong> <code id="newPath">@Model.CurrentPath</code>
                                </div>
                            </div>
                        }
                        else if (Model.ParentId.HasValue)
                        {
                            <div class="alert alert-info">
                                <h6><i class="bi bi-diagram-3"></i> @Localizer["CategoryPathPreview"]</h6>
                                <div>
                                    <strong>@Localizer["Path"]</strong> <code id="newPath"></code>
                                </div>
                            </div>
                        }

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> @Localizer["Cancel"]
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-@(Model.IsNew ? "plus-circle" : "save")"></i> 
                                @(Model.IsNew ? Localizer["CreateCategory"] : Localizer["SaveChanges"])
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightbulb"></i> @Localizer["Tips"]</h5>
                </div>
                <div class="card-body">
                    <h6>@Localizer["NamingGuidelines"]</h6>
                    <ul class="small">
                        <li>@Localizer["UseClearDescriptiveNamesShort"]</li>
                        <li>@Localizer["KeepNamesConcise"]</li>
                        <li>@Localizer["UseTitleCase"]</li>
                        <li>@Localizer["AvoidSpecialCharacters"]</li>
                    </ul>

                    <h6 class="mt-3">@Localizer["HierarchyBestPractices"]</h6>
                    <ul class="small">
                        <li>@Localizer["LimitDepthTo3or4Levels"]</li>
                        <li>@Localizer["GroupRelatedContentTogether"]</li>
                        <li>@Localizer["UseConsistentNamingPatterns"]</li>
                        <li>@Localizer["PlanStructureBeforeCreating"]</li>
                    </ul>

                    <h6 class="mt-3">@Localizer["URLStructure"]</h6>
                    <p class="small">
                        @Localizer["CategoriesCreateHierarchicalURLs"]
                    </p>
                    <code class="small d-block mb-2">/wiki/docs/api/rest</code>
                    <p class="small text-muted">
                        @Localizer["BasedOn"] Documentation → API → REST
                    </p>
                </div>
            </div>

            @if (!Model.IsNew)
            {
                <div class="card mt-3">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> @Localizer["DangerZone"]</h5>
                    </div>
                    <div class="card-body">
                        <p class="small">
                            @Localizer["ChangingParentWillMoveCategory"]
                        </p>
                        <p class="small text-danger mb-0">
                            <strong>@Localizer["Warning"]:</strong> @Localizer["WarningWillUpdatePageURLs"]
                        </p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var nameInput = document.getElementById('Name');
            var parentSelect = document.getElementById('parentCategorySelect');
            var newPathElement = document.getElementById('newPath');
            
            function updatePathPreview() {
                if (!newPathElement) return;
                
                var categoryName = nameInput.value.trim() || '[Category Name]';
                var selectedOption = parentSelect.options[parentSelect.selectedIndex];
                var parentPath = selectedOption.getAttribute('data-path');
                
                if (parentPath && parentPath !== '') {
                    newPathElement.textContent = parentPath + ':' + categoryName;
                } else {
                    newPathElement.textContent = categoryName;
                }
            }
            
            // Update preview on input changes
            if (nameInput && parentSelect && newPathElement) {
                nameInput.addEventListener('input', updatePathPreview);
                parentSelect.addEventListener('change', updatePathPreview);
                
                // Initial update
                updatePathPreview();
            }
            
            // Form validation
            var form = document.querySelector('form');
            form.addEventListener('submit', function(e) {
                var name = nameInput.value.trim();
                
                if (!name) {
                    e.preventDefault();
                    nameInput.focus();
                    return false;
                }
                
                // Check for valid characters
                var validPattern = /^[a-zA-Z0-9\s\-_]+$/;
                if (!validPattern.test(name)) {
                    e.preventDefault();
                    alert('@Localizer["CategoryNameValidCharactersOnly"]');
                    nameInput.focus();
                    return false;
                }
            });
        });
    </script>
}
