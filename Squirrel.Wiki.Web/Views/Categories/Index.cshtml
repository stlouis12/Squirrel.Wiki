@model Squirrel.Wiki.Web.Models.Admin.CategoryViewModel
@{
    ViewData["Title"] = "Category Management";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="bi bi-folder-fill"></i> Category Management</h1>
            <p class="text-muted">Organize your wiki pages with hierarchical categories</p>
        </div>
        <div class="col-auto">
            <a asp-action="Create" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create Root Category
            </a>
        </div>
    </div>

    @if (Model.Categories.Any())
    {
        <div class="card">
            <div class="card-body">
                <div class="category-tree">
                    @foreach (var category in Model.Categories)
                    {
                        @await Html.PartialAsync("_CategoryTreeNode", category)
                    }
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Category Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="stat-box">
                            <h3 class="text-primary">@Model.Categories.Count</h3>
                            <p class="text-muted mb-0">Root Categories</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <h3 class="text-success">@Model.Categories.Sum(c => CountAllCategories(c))</h3>
                            <p class="text-muted mb-0">Total Categories</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <h3 class="text-info">@Model.Categories.Sum(c => c.PageCount + c.Children.Sum(ch => ch.PageCount))</h3>
                            <p class="text-muted mb-0">Categorized Pages</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <h3 class="text-warning">@Model.Categories.Max(c => GetMaxDepth(c, 1))</h3>
                            <p class="text-muted mb-0">Max Depth</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No categories found. 
            <a asp-action="Create" class="alert-link">Create your first category</a> to start organizing your wiki pages.
        </div>
    }

    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-question-circle"></i> About Categories</h5>
        </div>
        <div class="card-body">
            <p class="lead">Categories help organize your wiki content into a hierarchical structure.</p>
            
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="bi bi-check-circle text-success"></i> Key Features</h6>
                    <ul>
                        <li><strong>Hierarchical Structure:</strong> Create nested categories up to any depth</li>
                        <li><strong>Page Organization:</strong> Assign pages to categories for better navigation</li>
                        <li><strong>Breadcrumb Navigation:</strong> Automatic breadcrumbs based on category path</li>
                        <li><strong>Smart URLs:</strong> Category-based URLs (e.g., /wiki/docs/api/rest)</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6><i class="bi bi-lightbulb text-warning"></i> Best Practices</h6>
                    <ul>
                        <li>Use clear, descriptive category names</li>
                        <li>Keep hierarchy depth reasonable (3-4 levels max)</li>
                        <li>Group related content together</li>
                        <li>Use consistent naming conventions</li>
                        <li>Review and reorganize periodically</li>
                    </ul>
                </div>
            </div>

            <div class="alert alert-info mt-3">
                <i class="bi bi-info-circle"></i> <strong>Getting Started:</strong> 
                Click "Create Root Category" to create a top-level category. You can then add subcategories by clicking the "Add Subcategory" button on any category.
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the category "<strong id="deleteCategoryName"></strong>"?</p>
                <div id="deleteCategoryWarnings"></div>
                <p class="text-danger">
                    <i class="bi bi-exclamation-triangle"></i> This action cannot be undone.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteCategoryForm" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Delete Category
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@functions {
    private int CountAllCategories(Squirrel.Wiki.Web.Models.Admin.CategoryTreeNode node)
    {
        return 1 + node.Children.Sum(c => CountAllCategories(c));
    }

    private int GetMaxDepth(Squirrel.Wiki.Web.Models.Admin.CategoryTreeNode node, int currentDepth)
    {
        if (!node.Children.Any())
            return currentDepth;
        
        return node.Children.Max(c => GetMaxDepth(c, currentDepth + 1));
    }
}

@section Scripts {
    <script src="~/js/toast-notifications.js"></script>
    <script src="~/js/category-tree.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Show success/error messages via toast
            @if (!string.IsNullOrEmpty(Model.SuccessMessage))
            {
                <text>
                Toast.success('Category Saved', '@Html.Raw(Model.SuccessMessage.Replace("'", "\\'"))');
                </text>
            }
            
            @if (!string.IsNullOrEmpty(Model.ErrorMessage))
            {
                <text>
                Toast.error('Error', '@Html.Raw(Model.ErrorMessage.Replace("'", "\\'"))');
                </text>
            }

            // Initialize category tree
            CategoryTree.init();

            // Delete category functionality
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteCategoryModal'));
            var deleteForm = document.getElementById('deleteCategoryForm');
            var deleteCategoryName = document.getElementById('deleteCategoryName');
            var deleteCategoryWarnings = document.getElementById('deleteCategoryWarnings');

            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-category-btn')) {
                    var button = e.target.closest('.delete-category-btn');
                    var categoryId = button.getAttribute('data-category-id');
                    var categoryName = button.getAttribute('data-category-name');
                    var subcategoryCount = parseInt(button.getAttribute('data-subcategory-count') || '0');
                    var pageCount = parseInt(button.getAttribute('data-page-count') || '0');
                    
                    // Set form action and category name
                    deleteForm.action = '@Url.Action("Delete", "Categories")' + '/' + categoryId;
                    deleteCategoryName.textContent = categoryName;
                    
                    // Show warnings if applicable
                    var warnings = '';
                    if (subcategoryCount > 0) {
                        warnings += '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> This category has <strong>' + subcategoryCount + ' subcategory(ies)</strong>. Please delete or move them first.</div>';
                    }
                    if (pageCount > 0) {
                        warnings += '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> This category contains <strong>' + pageCount + ' page(s)</strong>. Please remove or recategorize them first.</div>';
                    }
                    deleteCategoryWarnings.innerHTML = warnings;
                    
                    // Disable delete button if there are warnings
                    var deleteButton = deleteForm.querySelector('button[type="submit"]');
                    if (subcategoryCount > 0 || pageCount > 0) {
                        deleteButton.disabled = true;
                    } else {
                        deleteButton.disabled = false;
                    }
                    
                    // Show modal
                    deleteModal.show();
                }
            });

            // Handle delete form submission
            deleteForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                var formData = new FormData(this);
                
                fetch(this.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Toast.success('Category Deleted', data.message || 'Category deleted successfully');
                        deleteModal.hide();
                        // Reload page after short delay
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        Toast.error('Delete Failed', data.message || 'Failed to delete category');
                        deleteModal.hide();
                    }
                })
                .catch(error => {
                    Toast.error('Delete Failed', 'Error deleting category: ' + error.message);
                    deleteModal.hide();
                });
            });
        });
    </script>
}
