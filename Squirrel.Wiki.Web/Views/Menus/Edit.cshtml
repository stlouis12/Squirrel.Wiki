@model Squirrel.Wiki.Web.Models.Admin.EditMenuViewModel
@{
    ViewData["Title"] = Model.IsNew ? "Create Menu" : $"Edit Menu: {Model.Name}";
}

<style>
    /* Ensure dropdown menus in preview appear above all content */
    #menuPreview .dropdown-menu {
        z-index: 9999 !important;
    }
    
    #menuPreview .nav-item.dropdown:hover .dropdown-menu {
        z-index: 9999 !important;
    }
</style>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>
                <i class="bi bi-menu-button-wide"></i> 
                @(Model.IsNew ? "Create New Menu" : "Edit Menu")
            </h1>
            <p class="text-muted">
                @(Model.IsNew ? "Create a new navigation menu using MenuMarkup syntax" : $"Editing: {Model.Name}")
            </p>
        </div>
        <div class="col-auto">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Menus
            </a>
        </div>
    </div>

    <form asp-action="Edit" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />

        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Menu Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Name" class="form-label">Menu Name</label>
                            <input asp-for="Name" class="form-control" placeholder="e.g., Main Navigation, Footer Menu" required />
                            <span asp-validation-for="Name" class="text-danger"></span>
                            <div class="form-text">
                                A descriptive name for this menu
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="MenuType" class="form-label">Menu Type</label>
                            <select asp-for="MenuType" asp-items="Model.MenuTypes" class="form-select" required>
                            </select>
                            <span asp-validation-for="MenuType" class="text-danger"></span>
                            <div class="form-text">
                                The type determines where and how this menu is used. Only one menu of each type can be active at a time.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label">Description</label>
                            <input asp-for="Description" class="form-control" placeholder="Brief description of this menu's purpose" />
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input asp-for="IsEnabled" class="form-check-input" type="checkbox" id="IsEnabledCheckbox" />
                                <label asp-for="IsEnabled" class="form-check-label" for="IsEnabledCheckbox">
                                    Active
                                </label>
                                <div class="form-text">
                                    When active, this menu will be displayed on the site. Activating this menu will deactivate any other menu of the same type.
                                </div>
                            </div>
                        </div>

                        <!-- Menu Markup (for MainNavigation and Sidebar) -->
                        <div class="mb-3" id="menuMarkupSection">
                            <label asp-for="MenuMarkup" class="form-label">Menu Markup</label>
                            <textarea asp-for="MenuMarkup" 
                                      class="form-control font-monospace" 
                                      rows="15" 
                                      id="menuMarkupEditor"
                                      placeholder="* [Home](/wiki/home)&#10;* [About](/wiki/about)"></textarea>
                            <span asp-validation-for="MenuMarkup" class="text-danger"></span>
                            <div class="form-text">
                                Use MenuMarkup syntax to define menu items (see syntax guide below)
                            </div>
                        </div>

                        <!-- Footer Zones (for Footer type only) -->
                        <div id="footerZonesSection" style="display: none;">
                            <div class="mb-3">
                                <label asp-for="FooterLeftZone" class="form-label">
                                    Footer Left Zone
                                    <span class="badge bg-secondary">Left-aligned</span>
                                </label>
                                <input asp-for="FooterLeftZone" 
                                       class="form-control font-monospace" 
                                       id="footerLeftZoneEditor"
                                       placeholder="Â© 2025 My Wiki - Built with [[.NET 8.0|https://dotnet.microsoft.com]]" />
                                <span asp-validation-for="FooterLeftZone" class="text-danger"></span>
                                <div class="form-text">
                                    Content for the left footer zone. Use [[Text|URL]] for links.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label asp-for="FooterRightZone" class="form-label">
                                    Footer Right Zone
                                    <span class="badge bg-secondary">Right-aligned</span>
                                </label>
                                <input asp-for="FooterRightZone" 
                                       class="form-control font-monospace" 
                                       id="footerRightZoneEditor"
                                       placeholder="[[GitHub|https://github.com/yourorg/yourrepo]] - [[Report Issue|https://github.com/yourorg/yourrepo/issues]]" />
                                <span asp-validation-for="FooterRightZone" class="text-danger"></span>
                                <div class="form-text">
                                    Content for the right footer zone. Use [[Text|URL]] for links.
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> @(Model.IsNew ? "Create Menu" : "Save Changes")
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="previewBtn">
                                <i class="bi bi-eye"></i> Preview
                            </button>
                            <a asp-action="Index" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Preview Panel -->
                <div class="card mb-4" >
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-eye"></i> Live Preview</h5>
                    </div>
                    <div class="card-body" style="overflow: visible; padding-bottom: 250px;">
                        <div id="menuPreview" class="border rounded p-3 bg-light" style="position: relative; z-index: 1000; overflow: visible;">
                            <p class="text-muted text-center">
                                <i class="bi bi-info-circle"></i><br />
                                Click "Preview" to see how your menu will render
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Syntax Guide -->
                <div class="card sticky-top" style="top: 1rem;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-question-circle"></i> Quick Reference</h5>
                    </div>
                    <div class="card-body">
                        <h6 class="text-primary">Basic Links</h6>
                        <pre class="bg-light p-2 rounded small mb-3"><code>* [Home](/wiki/home)
* [About](/wiki/about)</code></pre>

                        <h6 class="text-primary">Dropdown Menus</h6>
                        <pre class="bg-light p-2 rounded small mb-3"><code>* [Documentation]
** [Getting Started](/docs/start)
** [User Guide](/docs/guide)</code></pre>

                        <h6 class="text-primary">URL Tokens</h6>
                        <pre class="bg-light p-2 rounded small mb-3"><code>* [All Pages](%ALLPAGES%)
* [All Tags](%ALLTAGS%)
* [Categories](%ALLCATEGORIES%)
* [Search](%SEARCH%)
* [Search Box](%EMBEDDED_SEARCH%)
* [New Page](%NEWPAGE%)
* [Recent](%RECENTLYUPDATED%)</code></pre>

                        <h6 class="text-primary">Tags & Categories</h6>
                        <pre class="bg-light p-2 rounded small mb-3"><code>* [Tutorials](tag:tutorial)
* [Tech Articles](category:tech)</code></pre>

                        <h6 class="text-primary">Page Slugs</h6>
                        <pre class="bg-light p-2 rounded small mb-3"><code>* [Welcome](welcome-page)
* [FAQ](frequently-asked)</code></pre>

                        <div class="alert alert-info small mb-0">
                            <strong><i class="bi bi-lightbulb"></i> Tips:</strong>
                            <ul class="mb-0 ps-3 mt-2">
                                <li>Use <code>*</code> for top-level items</li>
                                <li>Use <code>**</code> for dropdown items</li>
                                <li>Dropdowns need no URL in header</li>
                                <li>URLs auto-resolve page slugs</li>
                                <li>External links work too!</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // Toggle between Menu Markup and Footer Zones based on MenuType
        function toggleMenuFields() {
            const menuType = parseInt(document.getElementById('MenuType').value);
            const menuMarkupSection = document.getElementById('menuMarkupSection');
            const footerZonesSection = document.getElementById('footerZonesSection');
            const menuMarkupEditor = document.getElementById('menuMarkupEditor');
            
            // MenuType.Footer = 2
            if (menuType === 2) {
                menuMarkupSection.style.display = 'none';
                footerZonesSection.style.display = 'block';
                menuMarkupEditor.removeAttribute('required');
            } else {
                menuMarkupSection.style.display = 'block';
                footerZonesSection.style.display = 'none';
                menuMarkupEditor.setAttribute('required', 'required');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            toggleMenuFields();
            
            // Add change event listener to MenuType dropdown
            document.getElementById('MenuType').addEventListener('change', toggleMenuFields);
        });

        document.getElementById('previewBtn').addEventListener('click', async function() {
            const menuMarkup = document.getElementById('menuMarkupEditor').value;
            const previewDiv = document.getElementById('menuPreview');
            
            if (!menuMarkup.trim()) {
                previewDiv.innerHTML = '<p class="text-muted text-center"><i class="bi bi-info-circle"></i><br />Enter some menu markup to preview</p>';
                return;
            }

            // Show loading state
            previewDiv.innerHTML = '<p class="text-center"><span class="spinner-border spinner-border-sm"></span> Generating preview...</p>';

            try {
                const response = await fetch('@Url.Action("Preview")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ menuMarkup: menuMarkup })
                });

                const result = await response.json();

                if (result.success) {
                    previewDiv.innerHTML = result.html || '<p class="text-muted">Empty menu</p>';
                } else {
                    previewDiv.innerHTML = `<div class="alert alert-danger mb-0"><i class="bi bi-exclamation-triangle"></i> ${result.error || 'Preview failed'}</div>`;
                }
            } catch (error) {
                previewDiv.innerHTML = `<div class="alert alert-danger mb-0"><i class="bi bi-exclamation-triangle"></i> Error: ${error.message}</div>`;
            }
        });

        // Auto-preview on load if editing existing menu
        @if (!Model.IsNew && !string.IsNullOrEmpty(Model.MenuMarkup))
        {
            <text>
            window.addEventListener('load', function() {
                document.getElementById('previewBtn').click();
            });
            </text>
        }
    </script>
}
