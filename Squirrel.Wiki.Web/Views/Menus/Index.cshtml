@model Squirrel.Wiki.Web.Models.Admin.MenuViewModel
@{
    ViewData["Title"] = "Site Customization";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="bi bi-palette"></i> Site Customization</h1>
            <p class="text-muted">Customize navigation bars, sidebars, and footer zones</p>
        </div>
        <div class="col-auto">
            <a asp-action="Create" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create New Menu
            </a>
        </div>
    </div>

    @if (Model.Menus.Any())
    {
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th class="text-center">Items</th>
                                <th class="text-center">Status</th>
                                <th>Last Modified</th>
                                <th>Modified By</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var menu in Model.Menus)
                            {
                                <tr>
                                    <td>
                                        <a href="@Url.Action("Edit", new { id = menu.Id })" class="text-decoration-none text-dark">
                                            <strong>@menu.Name</strong>
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">@menu.MenuType</span>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(menu.Description))
                                        {
                                            <span class="text-muted">@menu.Description</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted fst-italic">No description</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">@menu.ItemCount</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check form-switch d-inline-block">
                                            <input class="form-check-input menu-status-toggle" 
                                                   type="checkbox" 
                                                   id="menu_@menu.Id" 
                                                   data-menu-id="@menu.Id"
                                                   data-menu-name="@menu.Name"
                                                   @(menu.IsEnabled ? "checked" : "")
                                                   title="Enable/Disable this menu">
                                            <label class="form-check-label visually-hidden" for="menu_@menu.Id">
                                                Menu Status
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            @menu.ModifiedOn.ToString("MMM dd, yyyy HH:mm")
                                        </small>
                                    </td>
                                    <td>
                                        <small class="text-muted">@menu.ModifiedBy</small>
                                    </td>
                                    <td class="text-end">
                                        <button type="button" 
                                                class="btn btn-outline-danger btn-sm delete-menu-btn" 
                                                data-menu-id="@menu.Id"
                                                data-menu-name="@menu.Name"
                                                title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No menus found. 
            <a asp-action="Create" class="alert-link">Create your first menu</a> to get started.
        </div>
    }

    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-question-circle"></i> About MenuMarkup</h5>
        </div>
        <div class="card-body">
            <p class="lead">MenuMarkup is a simple, markdown-like syntax for creating navigation menus.</p>
            
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="bi bi-check-circle text-success"></i> Key Features</h6>
                    <ul>
                        <li><strong>Simple Syntax:</strong> Use asterisks (*) and markdown links</li>
                        <li><strong>Nested Menus:</strong> Create dropdowns with multiple levels</li>
                        <li><strong>Smart URLs:</strong> Support for tokens, page slugs, tags, and categories</li>
                        <li><strong>Bootstrap Integration:</strong> Renders as Bootstrap 5 navbar components</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6><i class="bi bi-lightbulb text-warning"></i> Special URL Tokens</h6>
                    <ul class="small">
                        <li><code>%ALLPAGES%</code> - All pages list</li>
                        <li><code>%ALLTAGS%</code> - All tags list (with counts)</li>
                        <li><code>%ALLCATEGORIES%</code> - All categories tree</li>
                        <li><code>%SEARCH%</code> - Search page</li>
                        <li><code>%EMBEDDED_SEARCH%</code> - Embedded search box (sidebar only)</li>
                        <li><code>%NEWPAGE%</code> - Create new page</li>
                        <li><code>%RECENTLYUPDATED%</code> - Recently updated pages</li>
                        <li><code>tag:name</code> - Pages with specific tag</li>
                        <li><code>category:name</code> - Pages in category</li>
                    </ul>
                </div>
            </div>

            <div class="alert alert-info mt-3">
                <i class="bi bi-info-circle"></i> <strong>Getting Started:</strong> 
                Click "Create New Menu" to build your first navigation menu. The editor includes a live preview and syntax guide.
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteMenuModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Menu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the menu "<strong id="deleteMenuName"></strong>"?</p>
                <p class="text-danger">
                    <i class="bi bi-exclamation-triangle"></i> This action cannot be undone.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteMenuForm" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Delete Menu
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/toast-notifications.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Show success/error messages via toast
            @if (!string.IsNullOrEmpty(Model.SuccessMessage))
            {
                <text>
                Toast.success('Menu Saved', '@Html.Raw(Model.SuccessMessage.Replace("'", "\\'"))');
                </text>
            }
            
            @if (!string.IsNullOrEmpty(Model.ErrorMessage))
            {
                <text>
                Toast.error('Error', '@Html.Raw(Model.ErrorMessage.Replace("'", "\\'"))');
                </text>
            }
            
            // Menu status toggle functionality
            document.querySelectorAll('.menu-status-toggle').forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    var menuId = this.getAttribute('data-menu-id');
                    var menuName = this.getAttribute('data-menu-name');
                    var isEnabled = this.checked;
                    var checkboxElement = this;
                    
                    // Show loading state
                    this.disabled = true;
                    
                    // Create form data with anti-forgery token
                    var formData = new FormData();
                    formData.append('id', menuId);
                    var token = document.querySelector('input[name="__RequestVerificationToken"]');
                    if (token) {
                        formData.append('__RequestVerificationToken', token.value);
                    }
                    
                    fetch('@Url.Action("ToggleActivation", "Menus")', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Show success toast
                            Toast.success('Menu Status', 'Menu "' + menuName + '" ' + (isEnabled ? 'enabled' : 'disabled') + ' successfully');
                            
                            // Reload the page to refresh both the table and the navigation bar
                            setTimeout(() => window.location.reload(), 500);
                        } else {
                            // Revert checkbox state on error
                            checkboxElement.checked = !isEnabled;
                            Toast.error('Menu Status', data.message || 'Failed to update menu status');
                            checkboxElement.disabled = false;
                        }
                    })
                    .catch(error => {
                        // Revert checkbox state on error
                        checkboxElement.checked = !isEnabled;
                        Toast.error('Menu Status', 'Error updating menu status: ' + error.message);
                        checkboxElement.disabled = false;
                    });
                });
            });

            // Delete menu functionality
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteMenuModal'));
            var deleteForm = document.getElementById('deleteMenuForm');
            var deleteMenuName = document.getElementById('deleteMenuName');

            document.querySelectorAll('.delete-menu-btn').forEach(function(button) {
                button.addEventListener('click', function() {
                    var menuId = this.getAttribute('data-menu-id');
                    var menuName = this.getAttribute('data-menu-name');
                    
                    // Set form action and menu name
                    deleteForm.action = '@Url.Action("Delete", "Menus")' + '/' + menuId;
                    deleteMenuName.textContent = menuName;
                    
                    // Show modal
                    deleteModal.show();
                });
            });

            // Handle delete form submission
            deleteForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                var formData = new FormData(this);
                
                fetch(this.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Toast.success('Menu Deleted', data.message || 'Menu deleted successfully');
                        deleteModal.hide();
                        // Reload page after short delay
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        Toast.error('Delete Failed', data.message || 'Failed to delete menu');
                        deleteModal.hide();
                    }
                })
                .catch(error => {
                    Toast.error('Delete Failed', 'Error deleting menu: ' + error.message);
                    deleteModal.hide();
                });
            });
        });
    </script>
}
