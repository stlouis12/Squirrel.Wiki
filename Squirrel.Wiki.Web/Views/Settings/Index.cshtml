@model Squirrel.Wiki.Web.Models.Admin.SettingsViewModel
@{
    ViewData["Title"] = Localizer["Settings"];
}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="bi bi-sliders"></i> @Localizer["Settings"]</h1>
            <p class="text-muted">@Localizer["ConfigureYourWiki"]</p>
        </div>
        <div class="col-auto">
            <a asp-controller="Admin" asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> @Localizer["BackToDashboard"]
            </a>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill"></i> @Model.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Settings Groups -->
    <div class="row">
        <div class="col-md-3 mb-4">
            <!-- Navigation -->
            <div class="list-group sticky-top" style="top: 20px;">
                @foreach (var group in Model.Groups)
                {
                    <a href="#group-@group.Name.ToLower()" class="list-group-item list-group-item-action">
                        <i class="@group.Icon"></i> @group.Name
                    </a>
                }
            </div>
        </div>

        <div class="col-md-9">
            @foreach (var group in Model.Groups)
            {
                <div id="group-@group.Name.ToLower()" class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="@group.Icon"></i> @group.Name
                        </h5>
                        <small class="text-muted">@group.Description</small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 30%;">@Localizer["Setting"]</th>
                                        <th style="width: 50%;">@Localizer["Value"]</th>
                                        <th style="width: 20%;">@Localizer["Actions"]</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var setting in group.Settings)
                                    {
                                        <tr>
                                            <td>
                                                <strong>@setting.DisplayName</strong>
                                                @if (setting.IsRequired)
                                                {
                                                    <span class="badge bg-danger ms-1">@Localizer["Required"]</span>
                                                }
                                                @if (setting.IsFromEnvironment)
                                                {
                                                    <span class="badge bg-info ms-1" title="@Localizer["SettingConfiguredViaEnvironment", setting.EnvironmentVariableName]">
                                                        <i class="bi bi-lock-fill"></i> @Localizer["Environment"]
                                                    </span>
                                                }
                                                <br>
                                                <small class="text-muted">@setting.Description</small>
                                                @if (setting.IsFromEnvironment)
                                                {
                                                    <br>
                                                    <small class="text-info">
                                                        <i class="bi bi-info-circle"></i> 
                                                        @Localizer["SettingConfiguredViaEnvironment", setting.EnvironmentVariableName]
                                                    </small>
                                                }
                                            </td>
                                            <td>
                                                @if (setting.Type == Squirrel.Wiki.Web.Models.Admin.SettingType.Boolean)
                                                {
                                                    var isChecked = setting.Value?.ToLower() == "true";
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input quick-update-toggle" 
                                                               type="checkbox" 
                                                               data-key="@setting.Key"
                                                               @(isChecked ? "checked" : "")
                                                               @(setting.IsFromEnvironment ? "disabled" : "")>
                                                        <label class="form-check-label">
                                                            @(isChecked ? Localizer["Enabled"] : Localizer["Disabled"])
                                                        </label>
                                                    </div>
                                                }
                                                else if (setting.Type == Squirrel.Wiki.Web.Models.Admin.SettingType.TextArea)
                                                {
                                                    <div class="text-truncate" style="max-width: 400px;" title="@setting.Value">
                                                        @if (string.IsNullOrEmpty(setting.Value))
                                                        {
                                                            <em class="text-muted">@Localizer["NotSet"]</em>
                                                        }
                                                        else
                                                        {
                                                            @setting.Value
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <code>@(string.IsNullOrEmpty(setting.Value) ? Localizer["NotSet"] : setting.Value)</code>
                                                }
                                            </td>
                                            <td>
                                                @if (setting.IsFromEnvironment)
                                                {
                                                    <button class="btn btn-sm btn-outline-secondary" disabled title="@Localizer["SettingManagedByEnvironment"]">
                                                        <i class="bi bi-lock-fill"></i> @Localizer["Locked"]
                                                    </button>
                                                }
                                                else
                                                {
                                                    <a asp-action="Edit" asp-route-key="@setting.Key" class="btn btn-sm btn-outline-primary">
                                                        <i class="bi bi-pencil"></i> @Localizer["Edit"]
                                                    </a>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Quick update for boolean toggles
        document.querySelectorAll('.quick-update-toggle').forEach(toggle => {
            toggle.addEventListener('change', async function() {
                const key = this.dataset.key;
                const value = this.checked.toString();
                const label = this.nextElementSibling;
                
                try {
                    const response = await fetch('@Url.Action("QuickUpdate")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: `key=${encodeURIComponent(key)}&value=${encodeURIComponent(value)}`
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        label.textContent = this.checked ? '@Localizer["Enabled"]' : '@Localizer["Disabled"]';
                        
                        // Show success toast
                        showToast('@Localizer["Success"]', result.message, 'success');
                    } else {
                        // Revert toggle
                        this.checked = !this.checked;
                        showToast('@Localizer["Error"]', result.message, 'danger');
                    }
                } catch (error) {
                    // Revert toggle
                    this.checked = !this.checked;
                    showToast('@Localizer["Error"]', '@Localizer["FailedToUpdateSetting"]', 'danger');
                }
            });
        });
        
        function showToast(title, message, type) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <strong>${title}:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
}

@* Hidden anti-forgery token for AJAX requests *@
@Html.AntiForgeryToken()
